---
title: "Measles serology"
number-sections: true
format:
  html:
    toc: true
    toc-depth: 4
editor: source
editor_options: 
  chunk_output_type: console
#bibliography: references.bib
#csl: the-american-naturalist.csl
---

```{r include = FALSE, eval = FALSE}
# The code that adds the .nojekyll file to the GitHub repository:
file <- ".nojekyll"
file.create(file)
gert::git_add(file)
gert::git_commit("Adding the .nojekyll file")
gert::git_push()
rm(file)
```

```{r include = FALSE, eval = FALSE}
run_all <- function() {
  knitr::purl("index.qmd", "tmp.R", documentation = FALSE)
  source("tmp.R")
  file.remove("tmp.R")  
}

rerun_all <- function() {
  rm(list  = grep("run_all", ls(envir = .GlobalEnv), value = TRUE, invert = TRUE),
     envir = .GlobalEnv)
  run_all()
}
```

```{r include = FALSE}
par2 <- function(...) par(..., mgp = c(1.5, .5, 0), bty = "n")

knitr::knit_hooks$set(
  margin1 = function(before, options, envir) {
    if (before) par2(plt = c(.105, .97, .15, .95)) else NULL
  })

eps <- .8
knitr::opts_chunk$set(margin1    = TRUE,
                      fig.retina = 2,
                      fig.align  = "center",
                      fig.height = eps * 5, # default is 5
                      fig.width  = eps * 7) # default is 7 and maximum possible is 8.3
```


## Contants

The path to the data folder:

```{r}
if (grepl("arc|hoisy", Sys.getenv("USER"))) {
  path2data <- paste0("~/Library/CloudStorage/OneDrive-OxfordUniversityClinical",
                      "ResearchUnit/GitHub/choisy/measles serology/")
}
```


## Packages

Required packages:

```{r}
required <- c("readxl", "stringr", "purrr", "tidyr", "magrittr", "dplyr", "lubridate")
```

Installing those that are not installed yet:

```{r}
to_install <- required[! required %in% installed.packages()[,"Package"]]
if (length(to_install)) install.packages(to_install)
```

Loading the packages for interactive use:

```{r warning = FALSE, message = FALSE}
invisible(sapply(required, library, character.only = TRUE))
```


## Functions

A function that generates names of a vector of character strings from its content:

```{r}
set_names2 <- function(x) {
  setNames(x, x |>
             str_remove("^.*_") |> 
             str_remove("^.*-") |> 
             str_remove(".xlsx$"))
}
```


## Loading data

Loading all the excel files of the data folder:

```{r}
the3files <- path2data |> 
  list.files(full.names = TRUE) |> 
  set_names2() |> 
  map(read_excel, "Marc", col_types = "text")
```

A function that recode sex:

```{r}
recode_sex <- function(x) {
  sex_val <- sort(unique(x$sex))
  males   <- grep("^M|na", sex_val, TRUE, value = TRUE)
  females <- grep("^M|na", sex_val, TRUE, value = TRUE, invert = TRUE)
  mutate(x, across(sex, ~ case_match(.x, males ~ "male", females ~ "female")))
}
```

A piece common to all the collections:

```{r}
common_data_processing <- function(x) {
  x |> 
    filter(!if_all(everything(), is.na)) |>
    recode_sex() |>
    separate_wider_delim(ID, regex("\\s+"), names = c("sID", "cdate", "plate")) |>
    mutate(across(titer, as.double))
}
```

Combining the last two collections:

```{r}
last2collections <- the3files |> 
  extract(c("Dec2022", "Apr24")) |> 
  map(select, -c(age, date_collection)) |> 
  bind_rows() |> 
  common_data_processing() |> 
  mutate(collection_date = ymd(paste(year_collection, month_collection, day_collection,
                                     sep = "-"))) |> 
  select(participant, province, hospital, site, collection, sample_ID, age_group, sex,
         collection_date, plate, titer, conclusion)
```

Now to the first collection:

```{r}
first_collection <- the3files$DEC2019 |> 
  common_data_processing() |> 
  mutate(date_chr = if_else( grepl("[./]", date_collection), date_collection, NA),
         date_num = if_else(!grepl("[./]", date_collection), date_collection, NA),
         across(date_num, ~ .x |> as.numeric() |> as_date("1899-12-30")),
         across(date_chr, dmy),
         collection_date = coalesce(date_num, date_chr)) |> 
  select(participant, hospital, collection, sample_ID, age_group, sex,
         collection_date, plate, titer, conclusion)
```

The total collection:

```{r}
dataset <- bind_rows(last2collections, first_collection)
```

Which gives:

```{r}
dataset
```

